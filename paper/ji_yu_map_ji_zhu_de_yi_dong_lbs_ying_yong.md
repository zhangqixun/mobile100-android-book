# 基于Map技术的移动LBS应用
                                        刚占慧
                        （北京大学软件与微电子学院，北京  102600）
**摘要：**近年来我国移动通信网络技术已经发展的十分成熟，其中一类非常流行的应用程序是基于位置的服务LBS。LBS应用程序跟踪您的位置，并提供额外的服务，如定位附近的遍历设施以及提供线路规划建议等。基于位置的服务作为一种获取信息的新途径为我们的生活带来了极大的便利，同时响应应用开发的需求，在Android系统中应用位置服务已经成为不可改变的事实。本文从LBS的基础讲起，进一步研究地址定位与位置监控，并进行了简单实践。
**关键字：**Map; Android；移动LBS；应用

**引 言**  
基于位置的服务在最近几年里十分火爆，主要工作原理就是利用无线电通讯网络或GPS等定位确定移动设备所在的位置，基于地理位置的服务（LBS）在移动终端上的应用，因其根位置结合的紧密性，对移动人群需求的及时响应性，尤其是Foursquare应用的出现，通过签到方式加剧了移动LBS应用领域的飞速发展。然而早些年移动设备的功能极其有限，该功能并没有很好地开发，然而近年来基于位置服务的需求量急速增长，几乎任何移动设备上都涉及到基于地理位置的服务。
本文所研究的基于Baidu Map技术的移动LBS，结合目前热门的Android系统，通过GPRS/WIFI等网络接入方式，从互联网中实时获取当前位置相关的热点信息，并通过在Baidu Map上的应用获取移动设备的所在位置，实现定位。本文主要分三个部分分别对Android开发中基于位置的服务进行分析：LBS简介、地址定位，地理编码与反向地理编码，并将这些内容应于天气预报实际项目中。

**背 景**  
2010年以来，LBS（Location Based Service，基于地理位置服务）在全球发展迅猛，以美国Foursquare和中国“街旁网”为代表的地理位置平台服务受到广泛关注。和以往不同的是，LBS（结合手机服务）不仅实现谷歌地图的定位功能、大众点评网的地点搜索、评价和查看功能，同时也实现了开心网、人人网的SNS平台上的人际社交网络的互动，更为重要的是LBS整合了互联网平台和移动数据平台，创建了“基于地理位置”的信息服务，整合线上线下资源，实现了全方位的社会化网络服务系统，形成了全新的社会关系，以及群体、组织和个体的之间的相互连接和行动规律。
移动互联网时代的特点是移动终端的位置可以被服务器感知，这是一个巨大的飞跃。人们总是关注与发生在自己周围的信息，通过对移动终端设备获得越来越多有用的信息，将安卓系统作为载体，我们可以利用定位出的位置进行丰富多彩的操作，如天气预报中用户所在城市的自动选择，微博自动定位所在位置以及应用最广的路线查询我当前的位置等，这些信息包含着一个重要的信息——位置。

**LBS简介**  
LBS是基于位置的服务简称，它是通过电信移动运营商的无线电通讯网络（如GSM网、CDMA网）或外部定位方式(如GPS)获取移动终端用户的位置信息（地理坐标，或大地坐标），在地理信息系统（外语缩写：GIS、外语全称：Geographic Information System）平台的支持下，为用户提供相应服务的一种增值业务[1]。
Android是Google公司开发的开源的轻量级移动嵌入式操作系统[2]，它以Linux内核结合系统架构层、应用层，并通过Activity、Service、Content Provider、Receiver等四大组件提供对外的基础应用API，并支持JAVA、C/C++等多种编程语言，极大降低了移动应用的开发门槛。
总体上看LBS由移动通信网络和计算机网络结合而成，两个网络之间通过网关实现交互。移动终端通过移动通信网络发出请求，经过网关传递给LBS服务平台；服务平台根据用户请求和用户当前位置进行处理。并将结果通过网关返回给用户[1]。本质上它是一种概念较为宽泛的与空间位置有关的新型业务，即“确定地理位置”+“提供服务信息”的模式。

![](LBS.png)
图1 LBS架构

**地址定位**  
Android应用可以通过GPS来获取定位信息，并且实现了实时获取移动设备的地理位置，然而用户并不可能记住自己所在位置准确描述，我们使用位置服务的主要目的就是在用户不知道自己所在位置的情况下，系统可以进行自动定位给用户提供方便。例如地图导航，实时获取用户当前位置提供路线，美团会提示你所在位置与上次退出时登陆位置的不同，这些都不是用户输入的位置，而是系统自行定位。因此实现系统的自动定位便显得尤为重要。在本实验中采用了LocationClient和BDLocationListener两个接口，通过接受context进行位置监听注册，返回一个BDLocation对象具有用户所在位置的坐标、精度半径等信息，因为本实验中需要用到的就是用户所在的城市（区/县）信息，因此在这里直接使用location.getDistrict();获得“大兴区”，和我们的城市数据库不吻合，因此需要进行选择前两位“大兴”完成所在城市的定位，执行更新LBS操作executeUpdateByLBS(district)方法进行天气信息的更新。主要代码如下：
定义位置服务的对象并响应定位事件按钮：
![](locationDef.png) 
![](locationGet.png)  
图2 定义为值服务对象  
进行位置有效性判断，如果调用初始化LBS方法如图3所示：
![](locationJudge.png)   
图3 位置判断  
初始化LBS服务，定位模式默认有三种：Battery_Saving、Device_Sensors和Hight_Accuracy三种，本实验选用精确定位模式，通过给mLocationClient设置定位值选项，完成位置信息的存储，为接下来执行发起定位提供对象。
![](initLocation.png)
图4 初始化LBS服务  
通过获得到的SDK定位结果，在BDLocationListener的onReceive方法中获取，通过该类用户可以获得error code，位置的经纬度、街道等信息，本实验主要的目的是使用者所在城市的自动定位，进行天气情况的更新，因此在这里我们直接定位到district，并进行拆分获得和城市列表数据库要求的格式一致。
![](updateWeather.png)
图5 更新定位城市天气代码  
在完成上述核心代码后，注意使用百度的LBS位置服务功能必须在百度官网上申请一个权限秘钥并在AndroidManifest.xml中进行注册，同时把应用到的包加载到项目中来，完成所有工作后，即可实现定位服务与天气更新，如图：
